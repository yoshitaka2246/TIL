# Amazon S3
Amazon S3は「**Amazon Simple Storage Service**」の略で、AWSが提供する**オンラインストレージサービス**です。オンラインストレージとは、様々なデータをインターネット経由で保存できるサービスのことです。S3は**オブジェクトストレージ**を採用しており、データ容量が無制限に増やせたり、世界中どこからでもHTTPでアクセスできるというメリットがあります。

<div style="border-left: 4px solid #36c; background: #f0f4ff; padding: 0.8em 1em; border-radius: 4px;">
  <strong>💡 オブジェクトストレージ</strong> 
  パソコンのフォルダなどに採用されているフォルダストレージ（フォルダ構造で階層的に管理）と違い、1ファイル＝1オブジェクトとしてキーで管理するシステムです。「データとその情報」をまとめてクラウドに保存する形式です。
</div>


## 主な特徴
S3の特徴として**拡張性**、**耐久性**、**可用性**がある。
#### 拡張性(Scalability)
データ容量に制限がなく、ペタバイト級でも自動でスケールされるため、ユーザーがサーバーの容量管理をする必要がありません。使った分だけ課金されるシステムになっています。
#### 耐久性(Durability)
データをアップロードすると、複数のデータセンターに自動でコピーされるため、１つのサーバーが壊れてもデータが失われないという特徴があります。
耐久性は99.999999999%(イレブンナイン)と言われています。
#### 可用性(Availability)
可用性とは、システムが稼働し続けることを保証する度合いのことで、S3 Standardの可用性は年間で99.99%とされているため、安全に継続的に使用することができます。



## 静的Webサイト公開手順
ここからは実際にAmazon S3を使用して、簡単なhtmlサイトを公開する手順を説明します。
### 1-バケットの作成
1. AWSコンソールで`S3`を検索し、アクセスします。
2. 使用するリージョンを選択します(どこでも構いませんが、日本国内向けのサービスなら`東京
ap-northeast-1`を選択するのが無難です。)
3. **バケットを作成**をクリックします
4. **バケット名**を設定します
   バケット名は全世界で一意に定まる必要があります。他のユーザーが使用していないものに設定しましょう。

5. **オブジェクト所有者**を設定します
   `ACL無効（推奨）`と`ACL有効`が選択できますが、これから新しくバケットを作成する場合は`ACL無効（推奨）`で大丈夫です。

6. **バケットのブロックパブリックアクセス設定**をオフにします。
7. **バケットのバージョニング**を`無効`にします。
8. **デフォルトの暗号化**はデフォルトのままで大丈夫です。
9. `バケットを作成`をクリックすると、汎用バケットに作成したバケットが追加されます。

#### ACL
 ACLとはS3バケットやオブジェクトに対して、誰がアクセスできるかを設定する仕組みの一つです。古い仕組みのため、現在はIAMで管理することが推奨されています。ACL無効の場合でもIAMユーザーに権限を付与することで他の人が直接S3にアップロードすることができます。 


#### ブロックパブリックアクセス
ブロックパブリックアクセスはS3の公開アクセスを一括でブロックする仕組みで、**アカウント単位**、**バケット単位**、**アクセスポイント単位**で設定することができます。
AWSは、可能な限りすべてのブロックパブリックアクセス設定を有効にすることを推奨していますが、静的WebサイトをS3上で公開するには、この設定を適切に緩める必要があります。
ただし、AWSはWebサイトの公開について**CloudFront**経由での公開を推奨していることにも注意が必要です。


#### バケットのバージョニング
バージョニングとは、ファイルの変更履歴をすべて保存し、いつでも過去の状態に戻せる仕組みのことです。バケットの使用用途に応じて適切に設定する必要があります。
有効にするべきケース
- 業務データやログ、顧客データを保存
  誤って削除してしまった場合などのリスクを回避できる。
- 重要なファイルを扱うアプリ連携
  APIやユーザーによる誤操作対策
無効にするべきケース
- 静的Webサイトの公開
  ローカルでバージョン管理を行えば問題ありません。
- 大量ファイルを高頻度で更新する
  ストレージ使用量が無制限に増え、料金が高くなる場合があります。


#### デフォルトの暗号化
デフォルトの暗号化とはバケット単位で設定できるデータの暗号化サービスのことで、有効にすると、そのバケットに保存されるオブジェクトは自動的に暗号化されます。静的Webサイトを公開する場合であっても暗号化による問題は発生しないため、基本的にはオンにしておくことが推奨されます。
次の３つの暗号化方式があります。
1. SSE-S3（サーバーサイド暗号化 / Amazon S3管理キー）
  AWSが自動でキーを管理してくれ、設定が最も簡単です。暗号化アルゴリズムはAES-256です。管理の手間が不要なため、**ほとんどのケースではこの設定で十分**です。
2. SSE-KMS（サーバーサイド暗号化 / KMS管理キー）
   AWS Key Management Service (KMS) を利用します。暗号鍵の管理・アクセス制御を細かく設定でき、アクセスログにもキー使用履歴が残るため、セキュリティ要件が高い場合（金融・医療データなど）に利用されます。
3. SSE-C（カスタマー提供キー）
   クライアント側で独自の暗号鍵を提供して暗号化する方式です。高度な管理が必要で一般用途にはあまり使われません。



### 2-HTMLファイルの公開
1. 「汎用バケット」から作成したバケット名をクリックします
2. バケットのコンソール画面が表示されるため、`アップロード`から公開したいhtmlファイルをアップロードします。
3. バケットの**プロパティ**タブを開き、下にスクロールして**静的ウェブサイトホスティング**の**編集**を選択します。
   1. **静的ウェブサイトホスティング**を**有効**にします。
   2. **インデックスドキュメント**に`index.html`を入力します。
   3. **保存**をクリックします。
4. バケットの**アクセス許可**タブを開き、下にスクロールして**バケットポリシー**の**編集**を選択します。
   1. 以下のような安全なバケットポリシーを貼り付けます。（バケット名は自分のものに変更）
```json
{
  "Version": "2012-10-17",
  "Statement": [
    {
      "Sid": "PublicReadGetObject",
      "Effect": "Allow",
      "Principal": "*",
      "Action": "s3:GetObject",
      "Resource": "arn:aws:s3:::my-website-bucket/*"
    }
  ]
}
```
  2. **保存**を押します
5. バケットの**プロパティ**タブを開き、**静的ウェブサイトホスティング**に表示されているURLが公開URLになります。アクセスしてindex.htmlがきちんと表示されるか確認できたら成功です。

#### バケットポリシー
バケットポリシーのjsonファイルの各項目について説明します。

##### `"Version": "2012-10-17"`
ポリシー言語のバージョンを示します。いつの仕様に基づくかを表すだけで、**どのような場合でも常に**`"Version": "2012-10-17"`でOKです。

##### `"Statement": [ ... ]`
実際のルールをまとめる配列で、複数の許可や拒否ルールを定義することができます。

##### `"Sid": "PublicReadGetObject"`
StatementIDの略で、識別子です。ポリシー内で一意であれば**何でもよい**です。
例：「PublicRead」「AllowCloudFrontAccess」など。

##### `"Effect": "Allow"`
**許可か拒否**(`Allow`か`Deny`)を指定します。S3はデフォルトですべて拒否なので、明示的に`Allow`を設定することではじめてアクセスが可能になります。

##### `"Principal": "*"`
**誰に対して適用するか**を指定します。`"*"`は全世界のすべてのユーザーを意味します。
IAMユーザーや特定のサービスに限定したい場合は、
```json
"Principal": { "AWS": "arn:aws:iam::123456789012:user/Alice" }
```
のように記述します。

##### `"Action": "s3:GetObject"`
**何の操作を許可するか**を指定します。以下が主なアクションです。
- `s3:GetObject` : オブジェクトを取得（ダウンロード）
- `s3:PutObject` : アップロード
- `s3:DeleteObject` : 削除
- `s3:ListBucket` : バケット内の一覧取得
静的サイト公開では、閲覧だけでよいので`s3:GetObject`のみを許可します。

##### `"Resource": "arn:aws:s3:::my-website-bucket/*"`
**どのリソースに適用するか**を指定します。arnは「Amazon Resource Name（AWS内の一意な識別子）」です。
- `"arn:aws:s3:::"` : S3を意味するプレフィックス
- `"my-website-bucket"` : バケット名
- `"*"` : その中のすべてのオブジェクト
を意味します。

